<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>DNCL Simulator (Improved)</title>
    <!-- Blockly Library (v10.4.3) -->
    <script src="https://unpkg.com/blockly@10.4.3/blockly.min.js"></script>
    <!-- JS-Interpreter -->
    <script src="https://unpkg.com/js-interpreter@latest"></script>
    <style>
        :root {
            --header-height: 50px;
            --border-color: #ccc;
            --background-light: #eee;
            --background-panel: #fff;
            --text-color: #333;
            --button-bg: #f5f5f5;
            --button-hover-bg: #e0e0e0;
            --status-error-bg: #fbe9e7;
            --status-error-color: #c62828;
            --status-success-bg: #e8f5e9;
            --status-success-color: #2e7d32;
        }
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            color: var(--text-color);
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #aaa; }

        #header {
            height: var(--header-height);
            background: var(--background-light);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 15px;
            box-sizing: border-box;
            gap: 10px;
        }
        #header button {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid #bbb;
            background: linear-gradient(to bottom, #fff, #e9e9e9);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            box-shadow: 0 1px 1px rgba(0,0,0,0.05);
        }
        #header button:hover {
            background: linear-gradient(to bottom, #f5f5f5, #ddd);
            border-color: #999;
        }
        #header button:active {
            background: linear-gradient(to top, #f5f5f5, #ddd);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        #header button svg {
            width: 16px;
            height: 16px;
        }
        #header label {
            margin: 0 10px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        #runStatusDiv {
            margin-left: auto;
            font-weight: bold;
            padding: 5px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            min-width: 60px;
            text-align: center;
            transition: all 0.3s ease;
        }
        #runStatusDiv.status-error { background-color: var(--status-error-bg); color: var(--status-error-color); border-color: var(--status-error-color); }
        #runStatusDiv.status-success { background-color: var(--status-success-bg); color: var(--status-success-color); border-color: var(--status-success-color); }

        #mainContainer {
            display: flex;
            height: calc(100% - var(--header-height));
            box-sizing: border-box;
        }
        .pane {
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--background-panel);
        }
        #paneLeft { flex: 2; }
        #paneRight { flex: 1; min-width: 280px; display: flex; flex-direction: column;}

        .resizer-v {
            width: 8px;
            background: var(--background-light);
            cursor: col-resize;
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }
        .resizer-v:hover { background-color: #ddd; }
        
        .resizer-h {
            height: 8px;
            background: var(--background-light);
            cursor: row-resize;
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }
        .resizer-h:hover { background-color: #ddd; }


        #blocklyDiv, #outputDiv, #stateDiv { flex-grow: 1; overflow: auto; }
        #outputDiv { flex-basis: 50%; }
        #stateDiv { flex-basis: 50%;}

        #outputDiv, #stateDiv { padding: 10px; font-family: 'Menlo', 'Monaco', monospace; }
        
        .pane-header {
            background-color: #f0f0f0;
            padding: 6px 12px;
            font-weight: 600;
            font-size: 13px;
            border-bottom: 1px solid var(--border-color);
            color: #555;
        }
        .var-container {
            margin-bottom: 8px;
            padding: 5px 8px;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }
        .var-title {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 4px;
            padding-bottom: 2px;
            border-bottom: 1px solid #f0f0f0;
        }
        .array-table, .array-box { width: 100%; border-collapse: collapse; }
        .array-table th, .array-table td {
            border: 1px solid #ddd;
            padding: 4px;
            text-align: center;
            min-width: 30px;
            height: 30px;
            font-size: 12px;
        }
        .array-table th { background-color: #f7f7f7; }
        .array-box { display: flex; flex-wrap: wrap; gap: 5px; }
        .array-element {
            width: 35px;
            height: 35px;
            background-color: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ced4da;
            border-radius: 3px;
            position: relative;
            font-weight: bold;
            font-size: 13px;
        }
        .array-index {
            position: absolute;
            top: -14px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 10px;
            color: #6c757d;
        }
        .highlight { animation: highlight 1.2s ease-out; }
        @keyframes highlight {
            0%, 50% { background-color: #fff3cd; border-color: #f90; }
            100% { background-color: inherit; border-color: inherit; }
        }
        .function-call { background-color: #e8f5ff; border-left: 4px solid #4a86e8; padding: 5px 8px; margin: 5px 0; }
        .function-return { background-color: #e6ffe6; border-left: 4px solid #6aa84f; padding: 5px 8px; margin: 5px 0; }
        .error-output { color: #d9534f; font-weight: bold; }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 80vw;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        .modal-header h2 { margin: 0; }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
        }
        .modal-body {
            overflow: auto;
        }
        .modal-body#jsCodeDiv {
            background: #2d2d2d;
            color: #dcdcdc;
            padding: 10px;
            font-family: 'Menlo', 'Monaco', monospace;
            white-space: pre-wrap;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="header">
        <button id="runButton" title="実行 (F9)"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M8,5.14V19.14L19,12.14L8,5.14Z" /></svg> 実行</button>
        <button id="stepButton" title="ステップ実行 (F10)"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M15,18V6H13V18H15M11,18V6H9V18H11M7,18V6H5V18H7Z" /></svg> ステップ</button>
        <button id="resetButton" title="リセット"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M12,4C14.1,4 16.1,4.8 17.6,6.3C20.7,9.4 20.7,14.5 17.6,17.6C16.1,19.1 14.1,20 12,20C9.9,20 7.9,19.2 6.4,17.6C3.3,14.5 3.3,9.4 6.4,6.3C7.9,4.8 9.9,4 12,4M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z" /></svg> リセット</button>
        <button id="exportButton" title="ファイルにエクスポート"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z" /></svg></button>
        <button id="importButton" title="ファイルからインポート"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z" /></svg></button>
        <input type="file" id="importFile" accept=".xml,text/xml,.txt" style="display: none;">
        <button id="showCodeButton">コード表示</button>
        <label title="配列のインデックスを1から始めるか設定します">
            1始まり(1-based):
            <input type="checkbox" id="oneBasedCheckbox">
        </label>
        <div id="runStatusDiv">待機中</div>
    </div>

    <div id="mainContainer">
        <div id="paneLeft" class="pane">
            <div class="pane-header">ブロック</div>
            <div id="blocklyDiv"></div>
        </div>
        <div id="resizerV" class="resizer-v"></div>
        <div id="paneRight" class="pane">
            <div id="outputWrapper" style="display: flex; flex-direction: column; flex-basis: 50%; overflow: hidden;">
                <div class="pane-header">出力</div>
                <div id="outputDiv"></div>
            </div>
            <div id="resizerH" class="resizer-h"></div>
            <div id="stateDivWrapper" style="display: flex; flex-direction: column; flex-grow: 1; overflow: hidden;">
              <div class="pane-header">内部状態</div>
              <div id="stateDiv" style="flex-grow: 1; overflow-y: auto;"></div>
            </div>
        </div>
    </div>
    
    <div id="codeModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>生成されたコード (JavaScript)</h2>
                <button id="modalCloseButton" class="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="jsCodeDiv"></div>
        </div>
    </div>

    <div id="executionFinishedModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>実行終了</h2>
                <button id="executionFinishedModalCloseButton" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>プログラムの最後まで到達しました。</p>
            </div>
        </div>
    </div>


    <xml id="toolbox" style="display: none">
        <category name="入出力" colour="160">
            <block type="simple_display"></block>
            <block type="display"></block>
            <block type="external_input"></block>
            <block type="display_binary"></block>
        </category>
        <category name="変数と値" colour="230">
            <block type="assignment"></block>
            <block type="variable_access"></block>
            <block type="inc_dec"></block>
            <block type="number_literal"></block>
            <block type="string_literal"></block>
        </category>
        <category name="配列" colour="260">
            <block type="array_assignment_1d"></block>
            <block type="array_assignment_2d"></block>
            <block type="array_assignment_full"></block>
            <block type="array_assignment_full_2d"></block>
            <block type="array_access_1d"></block>
            <block type="array_access_2d"></block>
        </category>
        <category name="計算" colour="230">
            <block type="arithmetic"></block>
            <block type="square"></block>
            <block type="power"></block>
            <block type="random"></block>
        </category>
        <category name="条件と論理" colour="210">
            <block type="if_statement"></block>
            <block type="if_else_statement"></block>
            <block type="comparison"></block>
            <block type="logic_operation_jp"></block>
            <block type="logic_negate_jp"></block>
        </category>
        <category name="繰り返し" colour="120">
            <block type="for_loop"></block>
            <block type="while_loop"></block>
            <block type="do_while_loop"></block>
        </category>
        <category name="関数" custom="PROCEDURE" colour="290"></category>
        <category name="デバッグ" colour="0">
            <block type="breakpoint"></block>
        </category>
    </xml>
    
    <xml id="startBlocks" style="display:none"></xml>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        //==============================================
        // Global variables and constants
        //==============================================
        let myInterpreter = null;
        let workspace = null;
        let oneBasedMode = false;
        let ignoreBreakpoints = false;
        let previousDebugVars = {};
        const EXECUTION_TIMEOUT_STEPS = 2000000; 

        window.debugVars = {};

        const ORDER_ATOMIC = 0;
        const ORDER_NONE = 99;
        const ORDER_ASSIGNMENT = 2;
        const ORDER_FUNCTION_CALL = 2;
        const ORDER_MULTIPLICATION = 5;
        const ORDER_DIVISION = 5;
        const ORDER_MODULUS = 5;
        const ORDER_ADDITION = 6;
        const ORDER_SUBTRACTION = 6;
        const ORDER_LOGICAL_NOT = 4;
        const ORDER_LOGICAL_AND = 11;
        const ORDER_LOGICAL_OR = 12;
        const ORDER_RELATIONAL = 8;
        
        //==============================================
        // Utility Functions
        //==============================================
        function myPrompt(msg) {
            try {
                const result = window.prompt(msg);
                return result === null || result.trim() === '' ? "0" : result;
            } catch (e) {
                console.error("Input error:", e);
                return "0";
            }
        }
        
        window.nativeLog = function (varName, value) {
            window.debugVars[varName] = value;
        };

        function displayOutput(text, isError = false, addNewline = true) {
            const outputDiv = document.getElementById('outputDiv');
            if (isError) {
                const line = document.createElement('div');
                line.className = 'error-output';
                line.textContent = text;
                outputDiv.appendChild(line);
            } else {
                outputDiv.appendChild(document.createTextNode(text));
                if (addNewline) {
                    outputDiv.appendChild(document.createElement('br'));
                }
            }
            outputDiv.scrollTop = outputDiv.scrollHeight;
        }

        function displayBinary(num) {
            const bin = Number(num).toString(2);
            displayOutput(bin);
        }

        function setRunStatus(message, statusClass = '') {
            const statusDiv = document.getElementById('runStatusDiv');
            statusDiv.textContent = message;
            statusDiv.className = 'runStatusDiv'; // Reset classes
            if (statusClass) {
                statusDiv.classList.add(statusClass);
            }
        }

        //==============================================
        // Safe Array Access (with 1-based index handling)
        //==============================================
        function safeArrayAccess(arr, idx) {
            const nativeArr = myInterpreter ? myInterpreter.pseudoToNative(arr) : arr;
            const originalIdx = idx;
            if (oneBasedMode) { idx = idx - 1; }
            
            if (!Array.isArray(nativeArr)) {
                const msg = `エラー: ${nativeArr} は配列ではありません。`;
                displayOutput(msg, true);
                throw new Error(msg);
            }
            if (idx < 0 || idx >= nativeArr.length) {
                const msg = `エラー: 配列の範囲外アクセス (インデックス: ${originalIdx})`;
                displayOutput(msg, true);
                throw new Error(msg);
            }
            return nativeArr[idx];
        }

        function safeArrayAccess2d(arr, i, j) {
            const nativeArr = myInterpreter ? myInterpreter.pseudoToNative(arr) : arr;
            const originalI = i, originalJ = j;
            if (oneBasedMode) { i = i - 1; j = j - 1; }

            if (!Array.isArray(nativeArr)) {
                 const msg = `エラー: ${nativeArr} は2次元配列ではありません。`;
                displayOutput(msg, true);
                throw new Error(msg);
            }
            if (i < 0 || i >= nativeArr.length) {
                 const msg = `エラー: 2次元配列の1次元目の範囲外 (インデックス: ${originalI})`;
                displayOutput(msg, true);
                throw new Error(msg);
            }
            if (!Array.isArray(nativeArr[i])) {
                 const msg = `エラー: ${nativeArr[i]} は配列ではありません。`;
                displayOutput(msg, true);
                throw new Error(msg);
            }
            if (j < 0 || j >= nativeArr[i].length) {
                 const msg = `エラー: 2次元配列の2次元目の範囲外 (インデックス: ${originalJ})`;
                displayOutput(msg, true);
                throw new Error(msg);
            }
            return nativeArr[i][j];
        }
        
        //==============================================
        // Blockly Block Definitions and Generators
        //==============================================
        Blockly.defineBlocksWithJsonArray([
            {"type": "assignment", "message0": "%1 = %2", "args0": [{"type": "field_input", "name": "VAR", "text": "hensu"}, {"type": "input_value", "name": "VALUE"}], "previousStatement": null, "nextStatement": null, "colour": 230, "tooltip": "変数に値を代入する"},
            {"type": "number_literal", "message0": "%1", "args0": [{"type": "field_number", "name": "NUM", "value": 0}], "output": "Number", "colour": 230, "tooltip": "数値を入力する"},
            {"type": "string_literal", "message0": "「%1」", "args0": [{"type": "field_input", "name": "TEXT", "text": "テキスト"}], "output": "String", "colour": 230, "tooltip": "文字列を入力する"},
            {"type": "external_input", "message0": "外部入力 (%1)", "args0": [{"type": "field_dropdown", "name": "TYPE", "options": [["文字列", "STRING"], ["数値", "NUMBER"]]}], "output": null, "colour": 160, "tooltip": "ユーザーからの入力を受け取る"},
            {"type": "variable_access", "message0": "変数 %1", "args0": [{"type": "field_input", "name": "VAR", "text": "hensu"}], "output": null, "colour": 230, "tooltip": "変数の値を取得する"},
            {"type": "array_assignment_1d", "message0": "%1 [ %2 ] = %3", "args0": [{"type": "field_input", "name": "ARRAY", "text": "Hairetsu"}, {"type": "input_value", "name": "INDEX", "check": "Number"}, {"type": "input_value", "name": "VALUE"}], "previousStatement": null, "nextStatement": null, "colour": 260, "tooltip": "1次元配列の要素に値を代入する"},
            {"type": "array_assignment_2d", "message0": "%1 [ %2, %3 ] = %4", "args0": [{"type": "field_input", "name": "ARRAY", "text": "Gyoretsu"}, {"type": "input_value", "name": "INDEX1", "check": "Number"}, {"type": "input_value", "name": "INDEX2", "check": "Number"}, {"type": "input_value", "name": "VALUE"}], "previousStatement": null, "nextStatement": null, "colour": 260, "tooltip": "2次元配列の要素に値を代入する"},
            {"type": "array_assignment_full", "message0": "%1 = { %2 }", "args0": [{"type": "field_input", "name": "ARRAY", "text": "Hairetsu"}, {"type": "field_input", "name": "ELEMENTS", "text": "87,45,72,100"}], "previousStatement": null, "nextStatement": null, "colour": 260, "tooltip": "配列全体に値を代入する"},
            {"type": "array_assignment_full_2d", "message0": "%1 = { %2 }", "args0": [{"type": "field_input", "name": "ARRAY", "text": "Gyoretsu"}, {"type": "field_input", "name": "ELEMENTS", "text": "1,2;3,4"}], "previousStatement": null, "nextStatement": null, "colour": 260, "tooltip": "2次元配列全体に値を代入する（行はセミコロン、要素はカンマ区切り）"},
            {"type": "array_access_1d", "message0": "%1 [ %2 ]", "args0": [{"type": "field_input", "name": "ARRAY", "text": "Hairetsu"}, {"type": "input_value", "name": "INDEX", "check": "Number"}], "output": null, "colour": 260, "tooltip": "1次元配列の要素を参照する"},
            {"type": "array_access_2d", "message0": "%1 [ %2, %3 ]", "args0": [{"type": "field_input", "name": "ARRAY", "text": "Gyoretsu"}, {"type": "input_value", "name": "INDEX1", "check": "Number"}, {"type": "input_value", "name": "INDEX2", "check": "Number"}], "output": null, "colour": 260, "tooltip": "2次元配列の要素を参照する"},
            {"type": "arithmetic", "message0": "%1 %2 %3", "args0": [{"type": "input_value", "name": "A", "check": "Number"}, {"type": "field_dropdown", "name": "OP", "options": [["+", "+"], ["-", "-"], ["×", "*"], ["/", "/"], ["÷", "÷"], ["%", "%"]]}, {"type": "input_value", "name": "B", "check": "Number"}], "inputsInline": true, "output": "Number", "colour": 230, "tooltip": "算術演算"},
            {"type": "comparison", "message0": "%1 %2 %3", "args0": [{"type": "input_value", "name": "A"}, {"type": "field_dropdown", "name": "OP", "options": [["=", "==="], ["≠", "!=="], [">", ">"], [">=", ">="], ["<", "<"], ["<=", "<="]]}, {"type": "input_value", "name": "B"}], "output": "Boolean", "colour": 210, "tooltip": "比較演算子"},
            {"type": "logic_operation_jp", "message0": "%1 %2 %3", "args0": [{"type": "input_value", "name": "A", "check": "Boolean"}, {"type": "field_dropdown", "name": "OP", "options": [["かつ", "&&"], ["または", "||"]]}, {"type": "input_value", "name": "B", "check": "Boolean"}], "output": "Boolean", "colour": 210, "tooltip": "論理演算子（and/or）"},
            {"type": "logic_negate_jp", "message0": "でない %1", "args0": [{"type": "input_value", "name": "BOOL", "check": "Boolean"}], "output": "Boolean", "colour": 210, "tooltip": "論理否定"},
            {"type": "if_statement", "message0": "もし %1 ならば\n%2", "args0": [{"type": "input_value", "name": "CONDITION", "check": "Boolean"}, {"type": "input_statement", "name": "DO"}], "previousStatement": null, "nextStatement": null, "colour": 210, "tooltip": "if文"},
            {"type": "if_else_statement", "message0": "もし %1 ならば\n%2\nそうでなければ\n%3", "args0": [{"type": "input_value", "name": "CONDITION", "check": "Boolean"}, {"type": "input_statement", "name": "DO0"}, {"type": "input_statement", "name": "ELSE"}], "previousStatement": null, "nextStatement": null, "colour": 210, "tooltip": "if-else文"},
            {"type": "while_loop", "message0": "%1 の間、繰り返す\n%2", "args0": [{"type": "input_value", "name": "CONDITION", "check": "Boolean"}, {"type": "input_statement", "name": "DO"}], "previousStatement": null, "nextStatement": null, "colour": 120, "tooltip": "whileループ"},
            {"type": "do_while_loop", "message0": "繰り返し\n%1\nを、%2 になるまで実行する", "args0": [{"type": "input_statement", "name": "DO"}, {"type": "input_value", "name": "CONDITION", "check": "Boolean"}], "previousStatement": null, "nextStatement": null, "colour": 120, "tooltip": "後判定ループ"},
            {"type": "for_loop", "message0": "%1 を %2 から %3 まで %4 ずつ増やしながら、繰り返す\n%5", "args0": [{"type": "field_input", "name": "VAR", "text": "i"}, {"type": "input_value", "name": "FROM", "check": "Number"}, {"type": "input_value", "name": "TO", "check": "Number"}, {"type": "input_value", "name": "STEP", "check": "Number"}, {"type": "input_statement", "name": "DO"}], "previousStatement": null, "nextStatement": null, "colour": 120, "tooltip": "forループ"},
            {"type": "inc_dec", "message0": "%1 を %2", "args0": [{"type": "field_input", "name": "VAR", "text": "hensu"}, {"type": "field_dropdown", "name": "OP", "options": [["1 増やす", "+1"], ["1 減らす", "-1"]]}], "previousStatement": null, "nextStatement": null, "colour": 230, "tooltip": "変数のインクリメント/デクリメント"},
            {"type": "square", "message0": "二乗( %1 )", "args0": [{"type": "input_value", "name": "NUM", "check": "Number"}], "output": "Number", "colour": 230, "tooltip": "二乗を計算する"},
            {"type": "power", "message0": "べき乗( %1, %2 )", "args0": [{"type": "input_value", "name": "BASE", "check": "Number"}, {"type": "input_value", "name": "EXP", "check": "Number"}], "output": "Number", "colour": 230, "tooltip": "べき乗を計算する"},
            {"type": "random", "message0": "乱数( %1, %2 )", "args0": [{"type": "input_value", "name": "MIN", "check": "Number"}, {"type": "input_value", "name": "MAX", "check": "Number"}], "output": "Number", "colour": 230, "tooltip": "乱数を生成する"},
            {"type": "display_binary", "message0": "二進で表示する( %1 )", "args0": [{"type": "input_value", "name": "NUM", "check": "Number"}], "previousStatement": null, "nextStatement": null, "colour": 160, "tooltip": "数値を2進数で表示する"},
            {"type": "simple_display", "message0": "表示する %1 %2", "args0": [{"type": "input_value", "name": "VALUE"}, {"type": "field_dropdown", "name": "NEWLINE", "options": [["改行あり", "TRUE"], ["改行なし", "FALSE"]]}], "previousStatement": null, "nextStatement": null, "colour": 160, "tooltip": "値を表示する（改行の有無を選択）"},
            {"type": "display", "message0": "表示項目 %1", "args0": [{"type": "field_dropdown", "name": "NEWLINE", "options": [["改行あり", "TRUE"], ["改行なし", "FALSE"]]}], "previousStatement": true, "nextStatement": true, "colour": 160, "tooltip": "複数の値を連結して表示する", "mutator": "display_mutator"},
            {"type": "breakpoint", "message0": "ブレークポイント %1", "args0": [{"type": "input_value", "name": "NUMBER", "check": "Number"}], "previousStatement": null, "nextStatement": null, "colour": 0, "tooltip": "指定した番号のブレークポイントで処理を一時停止する"}
        ]);
        
        Blockly.Blocks['display_mutator_container'] = {
            init: function() { this.appendDummyInput().appendField("表示項目"); this.appendStatementInput("STACK"); this.setColour(160); this.setTooltip(""); this.contextMenu = false; }
        };
        Blockly.Blocks['display_mutator_item'] = {
            init: function() { this.appendDummyInput().appendField("項目"); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour(160); this.setTooltip(""); this.contextMenu = false; }
        };
        const displayMutator = {
            mutationToDom: function() { const container = document.createElement('mutation'); container.setAttribute('items', this.itemCount_); return container; },
            domToMutation: function(xmlElement) { this.itemCount_ = parseInt(xmlElement.getAttribute('items'), 10) || 0; this.updateShape_(); },
            decompose: function(workspace) { const containerBlock = workspace.newBlock('display_mutator_container'); containerBlock.initSvg(); let connection = containerBlock.getInput('STACK').connection; for (let i = 0; i < this.itemCount_; i++) { const itemBlock = workspace.newBlock('display_mutator_item'); itemBlock.initSvg(); connection.connect(itemBlock.previousConnection); connection = itemBlock.nextConnection; } return containerBlock; },
            compose: function(containerBlock) { let itemBlock = containerBlock.getInputTargetBlock('STACK'); const connections = []; while (itemBlock) { connections.push(itemBlock.valueConnection_); itemBlock = itemBlock.nextConnection && itemBlock.nextConnection.targetBlock(); } for (let i = 0; i < this.itemCount_; i++) { const connection = this.getInput('ADD' + i)?.connection.targetConnection; if (connection && connections.indexOf(connection) == -1) { connection.disconnect(); } } this.itemCount_ = connections.length; this.updateShape_(); for (let i = 0; i < this.itemCount_; i++) { if (connections[i]) { this.getInput('ADD' + i).connection.connect(connections[i]); } } },
            saveConnections: function(containerBlock) { let itemBlock = containerBlock.getInputTargetBlock('STACK'); let i = 0; while (itemBlock) { const input = this.getInput('ADD' + i); itemBlock.valueConnection_ = input && input.connection.targetConnection; i++; itemBlock = itemBlock.nextConnection && itemBlock.nextConnection.targetBlock(); } }
        };
        Blockly.Extensions.registerMutator('display_mutator', displayMutator, function() { this.itemCount_ = 1; this.updateShape_(); }, ['display_mutator_item']);
        Blockly.Blocks['display'] = {
            init: function() { this.jsonInit({"message0": "表示項目 %1", "args0": [{"type": "field_dropdown", "name": "NEWLINE", "options": [["改行あり", "TRUE"], ["改行なし", "FALSE"]]}], "previousStatement": true, "nextStatement": true, "colour": 160, "tooltip": "複数の値を連結して表示する", "mutator": "display_mutator"}); },
            updateShape_: function () { for (let i = 0; this.getInput('ADD' + i); i++) { this.removeInput('ADD' + i); } if(this.getInput('END')) this.removeInput('END'); if(this.getInput('EMPTY')) this.removeInput('EMPTY'); if (this.itemCount_ == 0) { this.appendDummyInput('EMPTY'); } else { for (let i = 0; i < this.itemCount_; i++) { const input = this.appendValueInput('ADD' + i); if (i > 0) { input.appendField("と"); } } } }
        };

        //==============================================
        // JavaScript Code Generators for Blocks
        //==============================================
        Blockly.JavaScript['assignment'] = function (block) { const varName = block.getFieldValue('VAR'); const value = Blockly.JavaScript.valueToCode(block, 'VALUE', ORDER_ASSIGNMENT) || '0'; return `${varName} = ${value};\nnativeLog('${varName}', ${varName});\n`; };
        Blockly.JavaScript['number_literal'] = (block) => [String(block.getFieldValue('NUM')), ORDER_ATOMIC];
        Blockly.JavaScript['string_literal'] = (block) => [JSON.stringify(block.getFieldValue('TEXT')), ORDER_ATOMIC];
        Blockly.JavaScript['external_input'] = function(block) { const type = block.getFieldValue('TYPE'); const code = "myPrompt('外部からの入力')"; if (type === 'NUMBER') { return [`Number(${code})`, ORDER_FUNCTION_CALL]; } else { return [`${code}`, ORDER_FUNCTION_CALL]; } };
        Blockly.JavaScript['variable_access'] = (block) => [block.getFieldValue('VAR'), ORDER_ATOMIC];
        Blockly.JavaScript['array_assignment_1d'] = function (block) { const arr = block.getFieldValue('ARRAY'); let idx = Blockly.JavaScript.valueToCode(block, 'INDEX', ORDER_NONE) || '0'; const val = Blockly.JavaScript.valueToCode(block, 'VALUE', ORDER_ASSIGNMENT) || '0'; let code = `${arr}[${oneBasedMode ? `(${idx} - 1)` : idx}] = ${val};\n`; code += `nativeLog('${arr}', ${arr});\n`; return code; };
        Blockly.JavaScript['array_assignment_2d'] = function (block) { const arr = block.getFieldValue('ARRAY'); let i = Blockly.JavaScript.valueToCode(block, 'INDEX1', ORDER_NONE) || '0'; let j = Blockly.JavaScript.valueToCode(block, 'INDEX2', ORDER_NONE) || '0'; const val = Blockly.JavaScript.valueToCode(block, 'VALUE', ORDER_ASSIGNMENT) || '0'; const index1 = oneBasedMode ? `(${i} - 1)` : i; const index2 = oneBasedMode ? `(${j} - 1)` : j; let code = `${arr}[${index1}][${index2}] = ${val};\n`; code += `nativeLog('${arr}', ${arr});\n`; return code; };
        Blockly.JavaScript['array_assignment_full'] = function (block) { const arr = block.getFieldValue('ARRAY'); const elements = block.getFieldValue('ELEMENTS'); const splitted = elements.replace(/[{}]/g, '').split(',').map(s => { const trimmed = s.trim(); return isNaN(Number(trimmed)) ? JSON.stringify(trimmed) : Number(trimmed); }); return `${arr} = [${splitted.join(', ')}];\nnativeLog('${arr}', ${arr});\n`; };
        Blockly.JavaScript['array_assignment_full_2d'] = function (block) { const arr = block.getFieldValue('ARRAY'); const elementsText = block.getFieldValue('ELEMENTS') || ''; const rows = elementsText.split(';').map(rowText => { const elements = rowText.split(',').map(e => { const trimmed = e.trim(); return isNaN(Number(trimmed)) ? JSON.stringify(trimmed) : Number(trimmed); }); return `[${elements.join(',')}]`; }); return `${arr} = [${rows.join(',')}];\nnativeLog('${arr}', ${arr});\n`; };
        Blockly.JavaScript['array_access_1d'] = (block) => [`safeArrayAccess(${block.getFieldValue('ARRAY')}, ${Blockly.JavaScript.valueToCode(block, 'INDEX', ORDER_NONE) || '0'})`, ORDER_FUNCTION_CALL];
        Blockly.JavaScript['array_access_2d'] = (block) => [`safeArrayAccess2d(${block.getFieldValue('ARRAY')}, ${Blockly.JavaScript.valueToCode(block, 'INDEX1', ORDER_NONE) || '0'}, ${Blockly.JavaScript.valueToCode(block, 'INDEX2', ORDER_NONE) || '0'})`, ORDER_FUNCTION_CALL];
        Blockly.JavaScript['arithmetic'] = function (block) { if (block.getFieldValue('OP') === '÷') { const a = Blockly.JavaScript.valueToCode(block, 'A', ORDER_NONE) || '0'; const b = Blockly.JavaScript.valueToCode(block, 'B', ORDER_NONE) || '0'; return [`Math.floor(${a} / ${b})`, ORDER_FUNCTION_CALL]; } const OPERATORS = {'+': [' + ', ORDER_ADDITION], '-': [' - ', ORDER_SUBTRACTION], '*': [' * ', ORDER_MULTIPLICATION], '/': [' / ', ORDER_DIVISION], '%': [' % ', ORDER_MODULUS],}; const tuple = OPERATORS[block.getFieldValue('OP')]; const operator = tuple[0]; const order = tuple[1]; const argument0 = Blockly.JavaScript.valueToCode(block, 'A', order) || '0'; const argument1 = Blockly.JavaScript.valueToCode(block, 'B', order) || '0'; const code = argument0 + operator + argument1; return [code, order]; };
        Blockly.JavaScript['comparison'] = (block) => [`(${Blockly.JavaScript.valueToCode(block, 'A', ORDER_RELATIONAL) || '0'} ${block.getFieldValue('OP')} ${Blockly.JavaScript.valueToCode(block, 'B', ORDER_RELATIONAL) || '0'})`, ORDER_RELATIONAL];
        Blockly.JavaScript['logic_operation_jp'] = (block) => { const op = block.getFieldValue('OP'); const order = op === '&&' ? ORDER_LOGICAL_AND : ORDER_LOGICAL_OR; return [`(${Blockly.JavaScript.valueToCode(block, 'A', order) || 'false'} ${op} ${Blockly.JavaScript.valueToCode(block, 'B', order) || 'false'})`, order]; };
        Blockly.JavaScript['logic_negate_jp'] = (block) => [`(!${Blockly.JavaScript.valueToCode(block, 'BOOL', ORDER_LOGICAL_NOT) || 'false'})`, ORDER_LOGICAL_NOT];
        Blockly.JavaScript['if_statement'] = (block) => `if (${Blockly.JavaScript.valueToCode(block, 'CONDITION', ORDER_NONE) || 'false'}) {\n${Blockly.JavaScript.statementToCode(block, 'DO')}}\n`;
        Blockly.JavaScript['if_else_statement'] = (block) => `if (${Blockly.JavaScript.valueToCode(block, 'CONDITION', ORDER_NONE) || 'false'}) {\n${Blockly.JavaScript.statementToCode(block, 'DO0')}} else {\n${Blockly.JavaScript.statementToCode(block, 'ELSE')}}\n`;
        Blockly.JavaScript['while_loop'] = (block) => `while (${Blockly.JavaScript.valueToCode(block, 'CONDITION', ORDER_NONE) || 'false'}) {\n${Blockly.JavaScript.statementToCode(block, 'DO')}}\n`;
        Blockly.JavaScript['do_while_loop'] = (block) => `do {\n${Blockly.JavaScript.statementToCode(block, 'DO')}} while (!(${Blockly.JavaScript.valueToCode(block, 'CONDITION', ORDER_NONE) || 'false'}));\n`;
        Blockly.JavaScript['for_loop'] = function (block) { const varName = block.getFieldValue('VAR'); const fromVal = Blockly.JavaScript.valueToCode(block, 'FROM', ORDER_ASSIGNMENT) || '0'; const toVal = Blockly.JavaScript.valueToCode(block, 'TO', ORDER_RELATIONAL) || '0'; const stepVal = Blockly.JavaScript.valueToCode(block, 'STEP', ORDER_ASSIGNMENT) || '1'; if (Number(stepVal) === 0) { throw new Error("for-loop's step cannot be 0."); } const branch = Blockly.JavaScript.statementToCode(block, 'DO'); let operator = '<='; const stepBlock = block.getInputTargetBlock('STEP'); if(stepBlock && stepBlock.type === 'number_literal') { const stepNum = Number(stepBlock.getFieldValue('NUM')); if (stepNum < 0) { operator = '>='; } } else if (stepVal.trim().startsWith('-')) { operator = '>='; } const loopCode = `for (${varName} = ${fromVal}; ${varName} ${operator} ${toVal}; ${varName} += ${stepVal}) {\n  nativeLog('${varName}', ${varName});\n${branch}}\n`; const finalLog = `nativeLog('${varName}', ${varName});\n`; return loopCode + finalLog; };
        Blockly.JavaScript['inc_dec'] = (block) => { const varName = block.getFieldValue('VAR'); const op = block.getFieldValue('OP') === '+1' ? '++' : '--'; return `${varName}${op};\nnativeLog('${varName}', ${varName});\n`; };
        Blockly.JavaScript['square'] = (block) => [`(${Blockly.JavaScript.valueToCode(block, 'NUM', ORDER_NONE) || '0'} * ${Blockly.JavaScript.valueToCode(block, 'NUM', ORDER_NONE) || '0'})`, ORDER_MULTIPLICATION];
        Blockly.JavaScript['power'] = (block) => [`Math.pow(${Blockly.JavaScript.valueToCode(block, 'BASE', ORDER_NONE) || '0'}, ${Blockly.JavaScript.valueToCode(block, 'EXP', ORDER_NONE) || '0'})`, ORDER_FUNCTION_CALL];
        Blockly.JavaScript['random'] = (block) => [`(Math.floor(Math.random() * ((${Blockly.JavaScript.valueToCode(block, 'MAX', ORDER_NONE) || '0'} - ${Blockly.JavaScript.valueToCode(block, 'MIN', ORDER_NONE) || '0'}) + 1)) + ${Blockly.JavaScript.valueToCode(block, 'MIN', ORDER_NONE) || '0'})`, ORDER_FUNCTION_CALL];
        Blockly.JavaScript['display_binary'] = (block) => `displayBinary(${Blockly.JavaScript.valueToCode(block, 'NUM', ORDER_NONE) || '0'});\n`;
        Blockly.JavaScript['simple_display'] = (block) => { const value = Blockly.JavaScript.valueToCode(block, 'VALUE', ORDER_NONE) || '""'; const newline = block.getFieldValue('NEWLINE') === 'TRUE'; return `displayOutput(${value}, false, ${newline});\n`; };
        Blockly.JavaScript['display'] = function(block) { const parts = []; for (let i = 0; i < block.itemCount_; i++) { parts.push(Blockly.JavaScript.valueToCode(block, 'ADD' + i, ORDER_NONE) || '""'); } const text = `[${parts.join(', ')}].join('')`; const newline = block.getFieldValue('NEWLINE') === 'TRUE'; return `displayOutput(${text}, false, ${newline});\n`; };
        Blockly.JavaScript['breakpoint'] = function(block) { const number = Blockly.JavaScript.valueToCode(block, 'NUMBER', ORDER_NONE) || 'null'; return `checkBreakpoint(${number});\n`; };
        
        //==============================================
        // Interpreter Initialization
        //==============================================
        function initInterpreter(interpreter, globalObject) {
            function createNative(func) { return interpreter.createNativeFunction(func); }
            interpreter.setProperty(globalObject, 'displayOutput', createNative((text, isError, addNewline) => displayOutput(text !== null && text !== undefined ? text.toString() : "", isError, addNewline)));
            interpreter.setProperty(globalObject, 'displayBinary', createNative(num => displayBinary(num || 0)));
            interpreter.setProperty(globalObject, 'safeArrayAccess', createNative((arr, idx) => safeArrayAccess(arr, idx)));
            interpreter.setProperty(globalObject, 'safeArrayAccess2d', createNative((arr, i, j) => safeArrayAccess2d(arr, i, j)));
            interpreter.setProperty(globalObject, 'nativeLog', createNative((varName, value) => window.nativeLog(varName, interpreter.pseudoToNative(value))));
            interpreter.setProperty(globalObject, 'myPrompt', createNative(msg => myPrompt(interpreter.pseudoToNative(msg))));
            interpreter.setProperty(globalObject, 'checkBreakpoint', createNative((number) => { if (!ignoreBreakpoints) { myInterpreter.paused_ = true; myInterpreter.breakpointNumber = number; } }));
            const originalFuncCall = interpreter.functionCall;
            interpreter.functionCall = function(func, funcThis, args) { let funcName = (func.node && func.node.id) ? func.node.id.name : "匿名関数"; const argVals = args ? args.map(a => interpreter.pseudoToNative(a)) : []; displayOutput(`<div class='function-call'>関数呼び出し: ${funcName}(${argVals.join(", ")})</div>`); const result = originalFuncCall.call(this, func, funcThis, args); if (result !== undefined && func.node.type !== 'FunctionDeclaration') { const returnVal = interpreter.pseudoToNative(result); displayOutput(`<div class='function-return'>関数 ${funcName} の戻り値: ${returnVal}</div>`); } return result; };
        }

        //==============================================
        // State Visualization
        //==============================================
        function updateStateDisplayVisual() { const stateDiv = document.getElementById('stateDiv'); stateDiv.innerHTML = ""; let currentCopy = JSON.parse(JSON.stringify(window.debugVars)); for (const key in window.debugVars) { const container = document.createElement('div'); container.className = "var-container"; const title = document.createElement('div'); title.className = "var-title"; title.textContent = key; container.appendChild(title); const value = window.debugVars[key]; const oldValue = previousDebugVars[key]; if (Array.isArray(value)) { if (Array.isArray(value[0])) { const table = document.createElement('table'); table.className = 'array-table'; const thead = table.createTHead().insertRow(); thead.insertCell(); for (let j = 0; j < value[0].length; j++) { const th = document.createElement('th'); th.textContent = oneBasedMode ? j + 1 : j; thead.appendChild(th); } const tbody = table.createTBody(); for (let i = 0; i < value.length; i++) { const tr = tbody.insertRow(); const th = document.createElement('th'); th.textContent = oneBasedMode ? i + 1 : i; tr.appendChild(th); for (let j = 0; j < value[i].length; j++) { const td = tr.insertCell(); td.textContent = value[i][j]; if (!oldValue || !Array.isArray(oldValue) || !oldValue[i] || value[i][j] !== oldValue[i][j]) { td.classList.add('highlight'); } } } container.appendChild(table); } else { const arrayBox = document.createElement('div'); arrayBox.className = "array-box"; for (let i = 0; i < value.length; i++) { const elemDiv = document.createElement('div'); elemDiv.className = "array-element"; elemDiv.innerHTML = `<div class="array-index">${oneBasedMode ? i + 1 : i}</div>${value[i]}`; if (!oldValue || !Array.isArray(oldValue) || value[i] !== oldValue[i]) { elemDiv.classList.add('highlight'); } arrayBox.appendChild(elemDiv); } container.appendChild(arrayBox); } } else { const textDiv = document.createElement('div'); textDiv.textContent = value; if (value !== oldValue) { textDiv.classList.add('highlight'); } container.appendChild(textDiv); } stateDiv.appendChild(container); } previousDebugVars = currentCopy; }

        //==============================================
        // Execution Control
        //==============================================
        function resetExecution() { if (myInterpreter) myInterpreter = null; document.getElementById('outputDiv').innerHTML = ""; document.getElementById('stateDiv').innerHTML = ""; window.debugVars = {}; previousDebugVars = {}; setRunStatus("待機中"); }
        function prepareInterpreter() { if (myInterpreter) return true; resetExecution(); const allVariables = workspace.getAllVariables(); const varNames = allVariables.map(v => v.name); const declarationString = varNames.length > 0 ? `var ${[...new Set(varNames)].join(', ')};\n` : ''; const blockCode = Blockly.JavaScript.workspaceToCode(workspace); const finalCode = declarationString + blockCode; try { myInterpreter = new Interpreter(finalCode, initInterpreter); window.myInterpreter = myInterpreter; return true; } catch (e) { setRunStatus("コード生成エラー", "status-error"); displayOutput("インタプリタ生成エラー: " + e.message, true); console.error("Final code passed to interpreter:", finalCode); console.error(e); return false; } }
        function runToNextBreakpoint() { if (!prepareInterpreter()) return; ignoreBreakpoints = false; setRunStatus("ステップ実行中..."); let stepCount = 0; let finished = false; while (true) { if (stepCount++ > EXECUTION_TIMEOUT_STEPS) { displayOutput("実行がタイムアウトしました。無限ループの可能性があります。", true); setRunStatus("タイムアウト", "status-error"); myInterpreter = null; return; } try { if (!myInterpreter.step()) { finished = true; break; } if (myInterpreter.paused_) { break; } } catch (e) { displayOutput("実行エラー: " + e.message, true); setRunStatus("エラー発生", "status-error"); myInterpreter = null; return; } } updateStateDisplayVisual(); if (finished) { setRunStatus("プログラム終了", "status-success"); document.getElementById('executionFinishedModal').style.display = 'flex'; } else if (myInterpreter && myInterpreter.paused_) { const bpNum = myInterpreter.breakpointNumber; myInterpreter.paused_ = false; myInterpreter.breakpointNumber = null; const statusText = (bpNum !== null && bpNum !== undefined) ? `ブレークポイント ${bpNum}` : 'ブレークポイント'; setRunStatus(statusText); } }
        function runAll() { if (!prepareInterpreter()) return; ignoreBreakpoints = true; setRunStatus("一括実行中..."); let stepCount = 0; const BATCH_SIZE = 2000; const runner = () => { try { for (let i = 0; i < BATCH_SIZE; i++) { if (stepCount++ > EXECUTION_TIMEOUT_STEPS) { displayOutput("実行がタイムアウトしました。無限ループの可能性があります。", true); setRunStatus("タイムアウト", "status-error"); myInterpreter = null; return; } if (!myInterpreter || !myInterpreter.step()) { updateStateDisplayVisual(); setRunStatus("プログラム終了", "status-success"); myInterpreter = null; return; } } setTimeout(runner, 0); } catch (e) { displayOutput("実行エラー: " + e.message, true); updateStateDisplayVisual(); setRunStatus("エラー発生", "status-error"); myInterpreter = null; } }; runner(); }

        //==============================================
        // Pane Resizing Logic
        //==============================================
        function setupResizer(resizerEl, isVertical = true) { let x = 0, y = 0; let prevSiblingSize = 0; const mouseDownHandler = function (e) { e.preventDefault(); x = e.clientX; y = e.clientY; const prevSibling = resizerEl.previousElementSibling; if (isVertical) { prevSiblingSize = prevSibling.getBoundingClientRect().width; } else { prevSiblingSize = prevSibling.getBoundingClientRect().height; } document.addEventListener('mousemove', mouseMoveHandler); document.addEventListener('mouseup', mouseUpHandler); }; const mouseMoveHandler = function (e) { const prevSibling = resizerEl.previousElementSibling; if (isVertical) { const dx = e.clientX - x; const newWidth = prevSiblingSize + dx; if (newWidth > 100) { prevSibling.style.flex = `0 0 ${newWidth}px`; } } else { const dy = e.clientY - y; const newHeight = prevSiblingSize + dy; if (newHeight > 50) { prevSibling.style.flex = `0 0 ${newHeight}px`; } } window.dispatchEvent(new Event('resize')); }; const mouseUpHandler = function () { document.removeEventListener('mousemove', mouseMoveHandler); document.removeEventListener('mouseup', mouseUpHandler); }; resizerEl.addEventListener('mousedown', mouseDownHandler); }

        //==============================================
        // Import / Export Logic
        //==============================================
        function exportBlocks() { try { const xml = Blockly.Xml.workspaceToDom(workspace); const xmlText = Blockly.Xml.domToPrettyText(xml); const a = document.createElement('a'); a.href = 'data:text/xml;charset=utf-8,' + encodeURIComponent(xmlText); a.download = 'dncl_program.xml'; a.click(); } catch (e) { alert("エクスポート失敗: " + e.message); console.error(e); } }
        function importBlocks() { document.getElementById('importFile').click(); }
        function loadBlocksFromFile(file) { if (!file) return; const reader = new FileReader(); reader.onload = function(e) { const xmlText = e.target.result; try { const xml = Blockly.utils.xml.textToDom(xmlText); workspace.clear(); Blockly.Xml.domToWorkspace(xml, workspace); } catch (e) { alert("インポート失敗: ファイルが不正です。\n" + e.message); console.error(e); } }; reader.readAsText(file); }
        
        //==============================================
        // App Initialization
        //==============================================
        workspace = Blockly.inject('blocklyDiv', {
            toolbox: document.getElementById('toolbox'),
            scrollbars: true,
            zoom: { controls: true, wheel: true }
        });

        document.getElementById('runButton').addEventListener('click', runAll);
        document.getElementById('stepButton').addEventListener('click', runToNextBreakpoint);
        document.getElementById('resetButton').addEventListener('click', resetExecution);
        document.getElementById('exportButton').addEventListener('click', exportBlocks);
        document.getElementById('importButton').addEventListener('click', importBlocks);
        document.getElementById('importFile').addEventListener('change', (e) => loadBlocksFromFile(e.target.files[0]));
        document.getElementById('oneBasedCheckbox').addEventListener('change', (e) => { oneBasedMode = e.target.checked; });

        const codeModal = document.getElementById('codeModal');
        document.getElementById('showCodeButton').addEventListener('click', () => {
            const allVariables = workspace.getAllVariables();
            const varNames = allVariables.map(v => v.name);
            const declarationString = varNames.length > 0 ? `var ${[...new Set(varNames)].join(', ')};\n` : '';
            const blockCode = Blockly.JavaScript.workspaceToCode(workspace);
            const finalCode = declarationString + blockCode;
            document.getElementById('jsCodeDiv').textContent = finalCode;
            codeModal.style.display = 'flex';
        });
        document.getElementById('modalCloseButton').addEventListener('click', () => { codeModal.style.display = 'none'; });
        codeModal.addEventListener('click', (e) => { if (e.target === codeModal) { codeModal.style.display = 'none'; } });

        const executionFinishedModal = document.getElementById('executionFinishedModal');
        const executionFinishedModalCloseButton = document.getElementById('executionFinishedModalCloseButton');
        executionFinishedModalCloseButton.addEventListener('click', () => { executionFinishedModal.style.display = 'none'; });
        executionFinishedModal.addEventListener('click', (e) => { if (e.target === executionFinishedModal) { executionFinishedModal.style.display = 'none'; } });

        setupResizer(document.getElementById('resizerV'), true);
        setupResizer(document.getElementById('resizerH'), false);
        
        window.addEventListener('resize', () => Blockly.svgResize(workspace));
        
        window.addEventListener('beforeunload', (event) => {
            if (workspace.getAllBlocks(false).length > 0) {
                event.preventDefault();
                event.returnValue = ''; // Required for Chrome.
            }
        });

        try {
            const startXml = document.getElementById('startBlocks');
            if (startXml.innerHTML.trim()) {
                Blockly.Xml.domToWorkspace(startXml, workspace);
            }
        } catch (e) {
            console.error("Error loading start blocks:", e);
            displayOutput("起動時のブロック読み込みエラー: " + e.message, true);
        }
        
        workspace.scrollCenter();
    });
    </script>
</body>
</html>
