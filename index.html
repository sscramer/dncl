<!-- 
    Project Name: DNCL_Simulator
    Author: Shohei Yamazaki
    Contact: yamazaki-shohei（at）ed.pref.toyama.jp
    Enhanced Version: Improved UI and Mobile Support
-->

<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DNCL Simulator (v2.5)</title>
    <!-- Blockly Library (v10.4.3) - ビジュアルプログラミングUIを提供 -->
    <script src="https://unpkg.com/blockly@10.4.3/blockly.min.js"></script>
    <!-- JS-Interpreter - JavaScriptコードをステップ実行するためのライブラリ -->
    <script src="https://unpkg.com/js-interpreter@latest"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- ヘッダーエリア: 操作ボタンと設定 -->
    <div id="header">
        <div class="header-section">
            <button id="runButton" class="primary" title="実行 (F9)">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                    <path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.347c1.295.712 1.295 2.573 0 3.286L7.279 20.99c-1.25.687-2.779-.217-2.779-1.643V5.653Z" clip-rule="evenodd" />
                </svg>
                <span class="button-text">実行</span>
            </button>
            <button id="stepButton" title="ステップ実行 (F10)">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                    <path fill-rule="evenodd" d="M6.75 5.25a.75.75 0 0 1 .75-.75H9a.75.75 0 0 1 .75.75v13.5a.75.75 0 0 1-.75.75H7.5a.75.75 0 0 1-.75-.75V5.25Zm7.5 0a.75.75 0 0 1 .75-.75h1.5a.75.75 0 0 1 .75.75v13.5a.75.75 0 0 1-.75.75H15a.75.75 0 0 1-.75-.75V5.25Z" clip-rule="evenodd" />
                </svg>
                <span class="button-text">ステップ</span>
            </button>
            <button id="stepBackButton" title="戻る" disabled style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                  <path fill-rule="evenodd" d="M9.53 2.47a.75.75 0 0 1 0 1.06L4.81 8.25H15a6.75 6.75 0 0 1 0 13.5h-3a.75.75 0 0 1 0-1.5h3a5.25 5.25 0 1 0 0-10.5H4.81l4.72 4.72a.75.75 0 1 1-1.06 1.06l-6-6a.75.75 0 0 1 0-1.06l6-6a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" />
                </svg>
                <span class="button-text">戻る</span>
            </button>
            <button id="resetButton" title="リセット">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                  <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25Zm-1.72 6.97a.75.75 0 1 0-1.06 1.06L10.94 12l-1.72 1.72a.75.75 0 1 0 1.06 1.06L12 13.06l1.72 1.72a.75.75 0 1 0 1.06-1.06L13.06 12l1.72-1.72a.75.75 0 1 0-1.06-1.06L12 10.94l-1.72-1.72Z" clip-rule="evenodd" />
                </svg>
                <span class="button-text">リセット</span>
            </button>
        </div>

        <div class="header-divider"></div>

        <div class="header-section">
            <button id="exportButton" title="ファイルにエクスポート">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                  <path fill-rule="evenodd" d="M12 2.25a.75.75 0 0 1 .75.75v11.69l3.22-3.22a.75.75 0 1 1 1.06 1.06l-4.5 4.5a.75.75 0 0 1-1.06 0l-4.5-4.5a.75.75 0 1 1 1.06-1.06l3.22 3.22V3a.75.75 0 0 1 .75-.75Zm-9 13.5a.75.75 0 0 1 .75.75v2.25a1.5 1.5 0 0 0 1.5 1.5h13.5a1.5 1.5 0 0 0 1.5-1.5V16.5a.75.75 0 0 1 1.5 0v2.25a3 3 0 0 1-3 3H5.25a3 3 0 0 1-3-3V16.5a.75.75 0 0 1 .75-.75Z" clip-rule="evenodd" />
                </svg>
                <span class="button-text">保存</span>
            </button>
            <button id="copyXmlButton" title="XMLをクリップボードにコピー">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                  <path fill-rule="evenodd" d="M11.25 2.25c-1.32 0-2.463.8-2.864 1.946a.75.75 0 1 0 1.448.408c.27-1.02.934-1.604 1.416-1.604h3.75a.75.75 0 0 0 0-1.5h-3.75Zm-3.06 3.06a.75.75 0 0 0-1.06 1.06l.72.72H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25h6.75a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H8.69l.72-.72a.75.75 0 0 0-1.06-1.06l-2.25 2.25a.75.75 0 0 0 0 1.06l2.25 2.25Z" clip-rule="evenodd" />
                </svg>
                <span class="button-text">コピー</span>
            </button>
            <button id="importButton" title="ファイルからインポート">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                  <path fill-rule="evenodd" d="M11.25 2.25a.75.75 0 0 1 .75.75v11.69l3.22-3.22a.75.75 0 1 1 1.06 1.06l-4.5 4.5a.75.75 0 0 1-1.06 0l-4.5-4.5a.75.75 0 1 1 1.06-1.06l3.22 3.22V3a.75.75 0 0 1 .75-.75Z" clip-rule="evenodd" />
                </svg>
                <span class="button-text">開く</span>
            </button>
            <input type="file" id="importFile" accept=".xml,text/xml,.txt" style="display: none;">
        </div>

        <div class="header-divider"></div>

        <div class="header-section">
            <button id="showCodeButton" title="生成されたコードを表示">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                  <path fill-rule="evenodd" d="M13.5 6a.75.75 0 0 1 .75.75v10.5a.75.75 0 0 1-1.5 0V6.75a.75.75 0 0 1 .75-.75Zm-4.5 0a.75.75 0 0 1 .75.75v10.5a.75.75 0 0 1-1.5 0V6.75a.75.75 0 0 1 .75-.75Z" clip-rule="evenodd" />
                </svg>
                <span class="button-text">コード</span>
            </button>
            <button id="importFromPythonButton" title="Pythonコードからインポート">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                  <path fill-rule="evenodd" d="M19.904 4.044c.623.01 1.096.52 1.096 1.144v13.624c0 .624-.473 1.134-1.096 1.144l-5.322.062a1.5 1.5 0 0 1-1.428-1.056l-.52-1.378a.75.75 0 1 0-1.442.548l.52 1.378a3 3 0 0 0 2.856 2.112l5.322-.062c1.47-.024 2.596-1.254 2.596-2.73V5.188c0-1.476-1.127-2.706-2.596-2.73l-5.322-.062a3 3 0 0 0-2.856 2.112l-.52 1.378a.75.75 0 1 0 1.442.548l.52-1.378a1.5 1.5 0 0 1 1.428-1.056l5.322.062ZM12.75 11.25a.75.75 0 0 0 0-1.5H5.669l1.72-1.72a.75.75 0 0 0-1.06-1.06l-3 3a.75.75 0 0 0 0 1.06l3 3a.75.75 0 0 0 1.06-1.06l-1.72-1.72h7.081Z" clip-rule="evenodd" />
                </svg>
                <span class="button-text">Python</span>
            </button>
        </div>

        <div class="header-divider"></div>

        <div class="header-section">
            <label title="ステップ実行（戻り）機能を有効にします（β版）">
                <input type="checkbox" id="enableStepBackCheckbox">
                <span>戻り機能</span>
            </label>
            <label title="配列のインデックスを1から始めるか設定します">
                <input type="checkbox" id="oneBasedCheckbox">
                <span>1始まり</span>
            </label>
        </div>

        <div id="stepCounterDiv">ステップ: 0</div>
        <div id="runStatusDiv">待機中</div>
    </div>

    <!-- メインコンテンツエリア -->
    <main id="mainContainer">
        <!-- 左ペイン: Blocklyワークスペース -->
        <div id="paneLeft" class="pane">
            <div class="pane-header">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                  <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 9a.75.75 0 0 0-1.5 0v2.25H9a.75.75 0 0 0 0 1.5h2.25V15a.75.75 0 0 0 1.5 0v-2.25H15a.75.75 0 0 0 0-1.5h-2.25V9Z" clip-rule="evenodd" />
                </svg>
                ブロック
            </div>
            <div id="blocklyDiv"></div>
        </div>
        <!-- 垂直リサイザー -->
        <div id="resizerV" class="resizer-v"></div>
        <!-- 右ペイン: 出力と内部状態 -->
        <div id="paneRight" class="pane">
            <div class="mobile-tabs">
                <button class="tab-button active" data-tab="outputWrapper">出力</button>
                <button class="tab-button" data-tab="stateDivWrapper">内部状態</button>
            </div>
            <!-- 出力エリア -->
            <div id="outputWrapper" class="tab-content active">
                <div class="pane-header">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                      <path d="M5.625 1.5c-1.036 0-1.875.84-1.875 1.875v17.25c0 1.035.84 1.875 1.875 1.875h12.75c1.035 0 1.875-.84 1.875-1.875V12.75A3.75 3.75 0 0 0 18.75 9V3.375c0-1.036-.84-1.875-1.875-1.875H5.625Zm3.75 14.25a.75.75 0 0 0 0-1.5h-3a.75.75 0 0 0 0 1.5h3Z" />
                    </svg>
                    出力
                </div>
                <div id="outputDiv"></div>
            </div>
            <!-- 水平リサイザー -->
            <div id="resizerH" class="resizer-h"></div>
            <!-- 内部状態エリア -->
            <div id="stateDivWrapper" class="tab-content">
                <div class="pane-header">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                      <path d="M12.378 1.602a.75.75 0 0 0-.756 0L3 7.25V13.5a.75.75 0 0 0 .75.75h16.5a.75.75 0 0 0 .75-.75V7.25l-9.378-5.648ZM12 3.482l6.562 3.937h-13.124L12 3.482ZM5.25 9.75a.75.75 0 0 0 0 1.5h13.5a.75.75 0 0 0 0-1.5H5.25Z" />
                    </svg>
                    内部状態
                </div>
                <div id="stateDiv"></div>
            </div>
        </div>
</main>

    <!-- モーダルウィンドウ -->
    <!-- 生成コード表示モーダル -->
    <div id="codeModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>生成されたコード (JavaScript)</h2>
                <button id="modalCloseButton" class="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="jsCodeDiv"></div>
        </div>
    </div>

    <!-- Pythonインポートモーダル -->
    <div id="pythonImportModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Pythonコードからインポート</h2>
                <button id="pythonImportModalCloseButton" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p><strong>【β版】Pythonコードからインポート</strong></p>
                <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">
                    ごく基本的な構文のみ対応しています。複雑なコードは正しく変換されない場合があります。<br>
                    <strong>対応構文:</strong> 変数代入, リスト, input, print, random.choice, if/elif/else
                </p>
                <textarea id="pythonCodeTextarea" placeholder="ここにPythonコードを貼り付けてください..."></textarea>
                <button id="convertPythonButton">変換</button>
            </div>
        </div>
    </div>

    <!-- 実行終了通知モーダル -->
    <div id="executionFinishedModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>実行終了</h2>
                <button id="executionFinishedModalCloseButton" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>プログラムの最後まで到達しました。</p>
            </div>
        </div>
    </div>

    <!-- β機能警告モーダル -->
    <div id="betaWarningModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>警告</h2>
                <button id="betaWarningModalCloseButton" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>この機能はβ版です。ステップ実行（戻り）は正しく実行されない可能性があります。</p>
            </div>
        </div>
    </div>

    <!-- Blocklyツールボックス定義 (XML) -->
    <xml id="toolbox" style="display: none">
        <category name="入出力" colour="160">
            <block type="simple_display"></block>
            <block type="display"></block>
            <block type="external_input"></block>
            <block type="display_binary"></block>
        </category>
        <category name="変数と値" colour="230">
            <block type="assignment"></block>
            <block type="variable_access"></block>
            <block type="inc_dec"></block>
            <block type="number_literal"></block>
            <block type="string_literal"></block>
        </category>
        <category name="配列" colour="260">
            <block type="array_assignment_1d"></block>
            <block type="array_assignment_2d"></block>
            <block type="array_assignment_full"></block>
            <block type="array_assignment_full_2d"></block>
            <block type="array_access_1d"></block>
            <block type="array_access_2d"></block>
            <block type="array_length"></block>
        </category>
        <category name="計算" colour="230">
            <block type="math_free_input"></block>
            <block type="arithmetic"></block>
            <block type="square"></block>
            <block type="power"></block>
            <block type="random"></block>
            <block type="random_float"></block>
            <block type="random_choice"></block>
        </category>
        <category name="条件と論理" colour="210">
            <block type="if_statement"></block>
            <block type="if_else_statement"></block>
            <block type="comparison"></block>
            <block type="logic_operation_jp"></block>
            <block type="logic_negate_jp"></block>
        </category>
        <category name="繰り返し" colour="120">
            <block type="for_loop"></block>
            <block type="while_loop"></block>
            <block type="do_while_loop"></block>
        </category>
        <category name="関数" custom="PROCEDURE" colour="290"></category>
        <category name="デバッグ" colour="0">
            <block type="breakpoint"></block>
        </category>
    </xml>

    <!-- 起動時に読み込むブロック（空） -->
    <xml id="startBlocks" style="display:none"></xml>

    <script src="script.js"></script>
</body>

</html>
